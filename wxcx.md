# 微信查询

* ESAP可对接微信公众号/企业微信的应用回调接口，自定义SQL语句，自定义权限，实现搜索引擎式超级查询。

* 需配置应用的`token`和`EncodingAesKey`，回调URL规则：
	`http://外网host/wx/应用名`

例如，假设外网域名是io.erp8.net，9090端口映射到内网ESAP服务器，那么回调URL如下:
	`http://io.erp8.net:9090/wx/esap`

!> 注意，公众号(服务号/订阅号)必须使用80端口，如无80端口可以用nginx或caddy做反向代理。

## 查询原理

* 系统根据用户输入的第一个关键字（例如下图的`库存`），扫描esap_cx表中对应的sql，执行并返回结果。

* 其余关键字视为查询参数（例如下图中的`名`,`手机`），sql中可以使用`{{.p1}},{{.p2}}`表示这些参数，用于替换where条件。

```sql
select 品号,名 as 品名,库存 from 库存表 where {{.p1}} like '%{{.p2}}%'
```

![](./img/s2.png)

## 参数解释

* 用户的输入按逗号或空格分隔，被解析为`p0，p1，p2...pn`,以及一个特别的`P`(大写)代表所有输入内容

> 例如输入：`库存，手机，一号仓` 会被解析为参数组：`p0=库存，p1=手机，p2=一号仓,P=库存，手机，一号仓`

* 在sql模板中使用`{{.pn}}`作参数替换，例如：
 
```sql
select 姓名,工号 from {{.p0}} where 姓名='{{.p1}}'
```

!> 微信查询使用的必要前提是会`sql`，请自行学习！

## 数据字典

微信查询主要扫描`esap_cx`表，对应字段解析如下：

|字段|描述|必填|备注|
|:----:|:--:|:--:|:----|
|name|查询名称|是|绑定查询第一个关键字|
|mKey|微信菜单id|否|绑定菜单id|
|tmpl|sql模板|是||
|mode|模式|否|0-全部，1-仅图片文件，2-新建模式，3-模板消息|
|nextFn|下一步|否|下一步任意输入必然执行指定查询|
|entermsg|进入提醒|否|可以是一个select语句|
|aclUser|用户权限|否|@all代表全体可用|
|aclDept|部门权限|否|逗号隔开多个ID或名称|
|aclTag|标签权限|否|逗号隔开多个ID或名称|
|aclApp|应用权限|是|逗号(小写)隔开多个配置应用名或用@all|
|app|专用查询|否|绑定一个配置的应用名,即专用查询|
|db|数据源名称|否|跨账套|
|url|文章URL|否|有值时返回文章，可使用{\{.pn\}}参数|
|pic|文章封面图片|否||
|tmpid|模板ID|否|模板消息ID，服务号支持|
|appid|小程序ID|否|模板消息中关联的小程序ID，服务号支持|
|safe|保密消息模式|否|1表示保密|
|id|自增编号|否|唯一|

* sql模板位置：`sql/sys/wxcx.get`

## 模板特性

#### 多重查询

* 可以写`多个select`语句，这些语句结果都能返回（sql2005+）。

![](./img/s2-2.png)
<img src="./img/s2-3.jpg" width="240"> 

#### UUID

* `{{uuid}}` 对应一个全球唯一的id, 可用于构建自动编号。

#### 企业号通讯录变量

* `{{姓名}}` 对应 `姓名`
* `{{账号}}` 对应 `账号`
* `{{部门}}` 对应 `部门`
* `{{职位}}` 对应 `职位`
* `{{性别}}` 对应 `性别`
* `{{手机}}` 对应 `手机号`
* `{{邮箱}}` 对应 `邮箱`
* `{{别名}}` 对应 `别名`

#### 更新数据

> sql中使用update/insert，`必须有一句select语句`用于回信息提示用户，例如：

```sql
insert xxx(...) values(...)
...
select N'你的信息已成功提交，谢谢使用'
```

<img src="./img/8.24.jpg" width="240">

![](./img/8.23.png)

## 进入提示

* `esap.yml`配置`entermsg=true`

* 企业微信应用回调勾选`上报进入应用事件`

![](./img/s2-0.png) 

* `esap_cx`表中的`entermsg`可写`select`来作为进入提醒。

## 语音查询

<img src="./img/8.13.png" width="240">
<img src="./img/8.14.png" width="240">
<img src="./img/8.15.png" width="240">

 
## 文章返回

* `url`有值时触发,`url`可使用参数`{{.pn}}`。

<img src="./img/wxcx-2.jpg" width="240">
<img src="./img/wxcx-3.jpg" width="240">

## 扫码查询

二维码或其他条码等,`esap_cx`表中的`mkey`与自定义菜单的`扫码弹框菜单ID`对应即可

<img src="./img/8.16.png" width="240">
<img src="./img/8.6.jpg" width="240">
<img src="./img/8.18.png" width="240">

## 多媒体查询

* sql结果`字段`或`别名`为：
 * `pic`
 * `files`
 * `voice`
 * `video`

* 支持返回多个`图片`或`附件`

<img src="./img/8.21.jpg" width="240">
<img src="./img/8.22.jpg" width="240">
<img src="./img/mutimedia-2.jpg" width="240">

!> 注意微信限制：图片一般不能超过2M,附件不超过20M

## 专用查询

* 专用查询字段(app)配置了某应用名`appName`后，该应用查询不再需要关键字引导，也不再响应其他关键字，仅需输入参数就可查询。

<img src="./img/8.38.jpg" width="240">

* 专用查询可直接扫二维码秒查。

<img src="./img/8.44.jpg" width="240">

## 菜单查询

设置`mkey`，与微信应用自定义`菜单ID`一致。

<img src="./img/8.27.jpg" width="320">
<img src="./img/8.28.jpg" width="320">

## 连续查询<span style="color:red">(new)</span>

设置`下一步`字段，接下来的输入必然执行该查询，可`多级连续`。

<img src="./img/wxcx2-lxcx.jpg" width="320">

* 第一个发起的查询的参数在连续查询中解析为`pf0，pf1，pf2...`

* 上一次查询的参数在连续查询中解析为`pp0，pp1，pp2...`